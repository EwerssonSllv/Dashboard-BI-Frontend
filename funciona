
function toggleProductForm() {
    const form = document.getElementById("productForm");
    form.style.display = form.style.display === "none" ? "block" : "none";
}

async function createProduct() {
    const name = document.getElementById("productName").value;
    const image = document.getElementById("productImage").value;
    const price = document.getElementById("productPrice").value;
    const stock = document.getElementById("productStock").value;

    const token = localStorage.getItem('Authorization');
    if (!token) {
        alert('Você precisa estar autenticado para criar um produto.');
        return;
    }

    const product = {
        name: name,
        image: image,
        price: price,
        stock: stock
    };

    try {
        const response = await fetch(endpointProduct, {  
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${token}`
            },
            body: JSON.stringify(product)
        });

        if (!response.ok) throw new Error("Erro ao criar o produto.");

        alert("Produto criado com sucesso!");
        loadProducts();  
    } catch (error) {
        alert(error.message);
    }
}

async function getProducts() {
    const key = "Authorization";
    const token = localStorage.getItem(key);

    if (!token) {
        window.location = "./login.html"; 
        return;
    }  

    try {
        const response = await fetch(endpointAllProducts, {
            method: "GET",
            headers: new Headers({
                Authorization: `Bearer ${token}`,
            }),
        });

        if (response.status === 401) {
            window.location = "login.html";
            return;
        }

        if (!response.ok) {
            console.error("Erro na requisição:", response.status);
            const errorData = await response.text(); 
            console.error("Detalhes do erro:", errorData);
        }

        const data = await response.json();      
        show(data);
    } catch (error) {
        console.error("Erro ao buscar os produtos:", error);
        document.getElementById("products").innerHTML = `
            <tr>
                <td colspan="6">Erro ao carregar dados</td>
            </tr>`;
    }
}

function show(products) {
    let table = `
        <thead>
            <tr>
                <th>Nome</th>
                <th>Preço</th>
                <th>Estoque</th>
                <th>Imagem</th>
                <th>Ação</th>
            </tr>
        </thead>
        <tbody>`;

    if (products && products.length > 0) {
        for (let product of products) {
            table += `
                <tr>
                    <td>${product.name}</td>
                    <td>${product.price} R$</td>
                    <td>${product.stock} Unidades</td>
                    <td><img src="${product.image}" alt="${product.name}" style="width: 100px; height: 100px;"></td>
                    <td><button onclick="buyProduct('${product.id}')">Comprar</button></td>
                </tr>`;
        }
    } else {
        table += `
            <tr>
                <td colspan="5">Nenhum produto encontrado!</td>
            </tr>`;
    }

    table += `</tbody>`;
    document.getElementById("products").innerHTML = table;
}

function showSales(data) {
    const salesTable = document.getElementById("table-sales");
    const tbody = document.getElementById("sales");

    salesTable.style.display = "table";

    salesTable.querySelector("thead").innerHTML = ` 
        <tr>
            <th>Data</th>
            <th>Produto</th>
            <th>Preço</th>
            <th>Quantidade</th>
            <th>Estado</th>
        </tr>
    `;

    data.forEach(sale => {
        const row = document.createElement("tr");
        row.innerHTML = ` 
            <td>${sale.date || "N/A"}</td>
            <td>${sale.productName || "N/A"}</td>
            <td>R$ ${sale.productPrice || "N/A"}</td>
            <td>${sale.quantity || "N/A"}</td>
            <td>${sale.state || "N/A"}</td>
        `;
        tbody.appendChild(row);
    });
}

function clearSearch() {
    document.getElementById("searchInput").value = "";
}